<!DOCTYPE html>
    <html>
    <head>
        <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
        <title>Google Play Bundles 使用流程</title>
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
        
        <style>
.task-list-item { list-style-type: none; } .task-list-item-checkbox { margin-left: -20px; vertical-align: middle; }
</style>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        
        
    </head>
    <body>
        <h1 id="Google-Play-Bundles-%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B">Google Play Bundles 使用流程</h1>
<h2 id="1-%E7%AE%80%E4%BB%8B">1. 简介</h2>
<p><a href="https://developer.android.com/platform/technology/app-bundle">Google App Bundles</a>是一种基于Google Play的apk分发机制，它的主要作用是通过Google Play识别用户手机的各种参数例如屏幕分辨率、核心架构等等来加载相应的资源文件从而减少应用下载的大小，本质上我们并不需要对代码结构进行非常大的调整，最终我们编译得到是一个<code>.aab</code>文件而不是<code>.apk</code>，通过将<code>.aab</code>文件上传至Google Play，Google Play会自动完成分发工作。</p>
<h2 id="2-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">2. 注意事项</h2>
<p>完成 app signing 是使用App Bundles的<strong>必要条件</strong>，而且一旦Google Play上的Application加入了app signing，那是<strong>不可退出的</strong>。</p>
<h3 id="21-App-Signing-%E6%B5%81%E7%A8%8B">2.1 App Signing 流程</h3>
<ol>
<li>首先登录<a href="https://play.google.com/apps/publish/signup/">Google Play Console</a>，这个需要developer账号；</li>
<li>选择并进入需要接入Bundles的Application；</li>
</ol>
<!-- {% asset_img bundles-0.png %} -->
<p><img src="file:///e:\pythonprojects\craft\md\bundles-0.png" alt=""></p>
<ol start="3">
<li>根据下图显示，找到<code>Release management-&gt;App signing</code>，倘若此Application从未进行过App signing，则显示结果和下图相同；</li>
</ol>
<!-- {% asset_img bundles-1.png %} -->
<p><img src="file:///e:\pythonprojects\craft\md\bundles-1.png" alt=""></p>
<ol start="4">
<li>准备两种key：<code>app signing key</code>和<code>upload key</code>。<code>app signing key</code>是最终我们的应用发布出去被签名使用的key，<code>upload key</code>是用于上传apk或者aab文件到Google时使用的key。下面介绍一下以前使用签名发布应用的流程以及通过<code>upload key</code>发布应用的流程</li>
</ol>
<pre><code class="language-java"><div><span class="hljs-comment">// 以前</span>
用release keystore签名我们的应用 -&gt; 上传至Google，Google验证签名是否相同 -&gt; 如果签名相同则确认可以发布 -&gt; 用户可以在Google Play上下载

<span class="hljs-comment">// upload key + app signing key</span>
用upload keystore签名我们的应用 -&gt; 上传至Google，Google验证签名是否与保存在Google服务器的upload key相同 -&gt; 如果签名相同则Google使用保存在Google服务器上的App signing key重新对应用签名，然后发布 -&gt; 用户可以在Google Play上下载

这里的App signing key可以用我们以前的release keystore；新的upload key可以是重新创建的keystore（风险低），也可以与release keystore相同（风险高）。

使用upload key的好处：
<span class="hljs-number">1</span>. 安全性，新创建的upload key仅用于上传应用时进行验证，如果丢失可以通过邮件重置upload key，不会对release key有威胁；
<span class="hljs-number">2</span>. 便捷性，最终签名发布是由Google完成的。
</div></code></pre>
<ol start="5">
<li>在上图的基础上选择<code>Export and upload a key from a Java keystore</code></li>
</ol>
<!-- {% asset_img bundles-2.png %} -->
<p><img src="file:///e:\pythonprojects\craft\md\bundles-2.png" alt=""></p>
<pre><code class="language-java"><div><span class="hljs-number">1</span>. 下载加密工具jar包PEPK；
<span class="hljs-number">2</span>. 命令行使用pepk.jar加密我们的app signing key，可以在--output参数设置生成的文件类型为.pepk；
<span class="hljs-number">3</span>. 上传.pepk文件；
<span class="hljs-number">4</span>. upload key这里显示的是Optional，如果没有上传重新创建的upload key，那么默认upload key与app signing key相同，但是这样风险高；
<span class="hljs-number">5</span>. 命令行导出upload key的证书，为.pem文件；
<span class="hljs-number">6</span>. 上传.pem文件；
<span class="hljs-number">7</span>. 如果上述格式都是正确的，那么我们提交之后的当前界面会变为下图。
</div></code></pre>
<!-- {% asset_img bundles-3.png %} -->
<p><img src="file:///e:\pythonprojects\craft\md\bundles-3.png" alt=""></p>
<ol start="6">
<li>测试上传Bundles，使用upload key签名Bundles文件（注意版本号），在<code>Release management-&gt;App releases</code>上传<code>.aab</code>文件，如果步骤正确，则可以上传成功，然后填一下<code>Release name</code>和<code>What's new in this release?</code>，<code>SAVE</code>之后<code>REVIEW</code>，最后可以<code>Start rollout to production</code></li>
</ol>
<!-- {% asset_img bundles-4.png %} -->
<p><img src="file:///e:\pythonprojects\craft\md\bundles-4.png" alt=""></p>
<ol start="7">
<li>如果rollout成功，那么就可以在Google Play上看到新发布的应用了。</li>
</ol>
<!-- {% asset_img bundles-5.png %} -->
<p><img src="file:///e:\pythonprojects\craft\md\bundles-5.png" alt=""></p>
<h3 id="22-%E5%8F%AF%E8%83%BD%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98">2.2 可能存在的问题</h3>
<p><a href="https://www.jianshu.com/p/86ffbf884f4a">第三方登录功能失效</a>（需要进一步测试）</p>
<p><a href="https://codelabs.developers.google.com/codelabs/your-first-dynamic-app/index.html#0">Building App Bundles Demo</a></p>

    </body>
    </html>